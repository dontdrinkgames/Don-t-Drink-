<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Don't Drink! - Play</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: white;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
            max-width: 800px;
        }
        
        .game-title {
            font-size: 3em;
            font-weight: 700;
            text-transform: uppercase;
            text-shadow: 3px 3px 10px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }
        
        .game-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .info-item {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 15px;
        }
        
        .mixmaster-indicator {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #ffe66d);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            animation: pulse 2s infinite;
            margin-left: 10px;
            display: inline-block;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .question-card {
            background: rgba(255,255,255,0.95);
            border-radius: 30px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .question-number {
            color: #667eea;
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .question-text {
            color: #333;
            font-size: 2em;
            font-weight: 600;
            margin: 30px 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .rating-section {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            padding: 20px 0;
            border-top: 2px solid #f0f0f0;
        }
        
        .rating-btn {
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.8em;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .rating-btn:hover {
            transform: scale(1.15);
        }
        
        .rating-btn.thumbs-up {
            border-color: #4ade80;
        }
        
        .rating-btn.thumbs-up:hover {
            background: #4ade80;
            border-color: #22c55e;
        }
        
        .rating-btn.thumbs-down {
            border-color: #f87171;
        }
        
        .rating-btn.thumbs-down:hover {
            background: #f87171;
            border-color: #ef4444;
        }
        
        .rating-btn.rated {
            transform: scale(0.9);
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .rating-label {
            color: #999;
            font-size: 0.85em;
            margin-top: 10px;
            text-align: center;
        }
        
        .control-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
        }
        
        .control-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .error-message {
            background: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            max-width: 800px;
            width: 100%;
            text-align: center;
        }
        
        .rating-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            color: #333;
            padding: 20px 40px;
            border-radius: 20px;
            font-size: 1.2em;
            font-weight: 600;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: fadeInOut 1s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }
    </style>
</head>
<body>
    <div class="game-header">
        <h1 class="game-title" id="gameTitle">Loading...</h1>
        <div class="game-info">
            <div class="info-item">Mode: <span id="gameMode">-</span></div>
            <div class="info-item">
                Intensity: <span id="gameIntensity">-</span>
                <span id="mixmasterIndicator" class="mixmaster-indicator" style="display: none;">üé≤ RANDOM</span>
            </div>
            <div class="info-item">Room: <span id="roomCode">-</span></div>
        </div>
    </div>
    
    <div class="error-message" id="errorMessage" style="display: none;"></div>
    
    <div class="question-card">
        <div class="question-number" id="questionNumber">Question 1</div>
        <div class="question-text" id="questionText">Loading question...</div>
        
        <div class="rating-section">
            <div>
                <button class="rating-btn thumbs-up" id="thumbsUp" onclick="rateQuestion('up')" title="Good question!">
                    üëç
                </button>
                <div class="rating-label">Good</div>
            </div>
            <div>
                <button class="rating-btn thumbs-down" id="thumbsDown" onclick="rateQuestion('down')" title="Bad question">
                    üëé
                </button>
                <div class="rating-label">Bad</div>
            </div>
        </div>
        
        <div>
            <button class="control-btn" id="nextBtn" onclick="nextQuestion()">Next Question</button>
        </div>
    </div>
    
    <script>
        // Game state
        let gameConfig = {};
        let currentQuestionIndex = 0;
        let currentQuestionId = null;
        let currentQuestionData = null;
        let hasRatedCurrentQuestion = false;
        
        // Game title mapping
        const gameTitleMap = {
            'nhie': 'Never Have I Ever',
            'fmk': 'Fuck, Marry, Kill',
            'wyr': 'Would You Rather',
            'hot': 'Hot Takes',
            'hottakes': 'Hot Takes'
        };
        
        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', function() {
            loadGameConfig();
            initializeGame();
        });
        
        function loadGameConfig() {
            // Get config from localStorage
            const storedConfig = localStorage.getItem('gameConfig');
            if (storedConfig) {
                gameConfig = JSON.parse(storedConfig);
                console.log('Loaded config:', gameConfig);
            }
            
            // Get params from URL
            const urlParams = new URLSearchParams(window.location.search);
            const roomCode = urlParams.get('room') || gameConfig.roomCode || 'OFFLINE';
            const game = urlParams.get('game') || gameConfig.game || 'nhie';
            
            gameConfig = {
                ...gameConfig,
                roomCode: roomCode,
                game: game,
                intensity: gameConfig.intensity || 'medium',
                mode: gameConfig.mode || 'offline'
            };
            
            console.log('Final config:', gameConfig);
        }
        
        function initializeGame() {
            // Update UI
            updateGameInfo();
            
            // Get first question
            loadNextQuestion();
        }
        
        function updateGameInfo() {
            const gameTitle = gameTitleMap[gameConfig.game] || gameConfig.game;
            document.getElementById('gameTitle').textContent = gameTitle;
            document.getElementById('gameMode').textContent = gameConfig.mode || 'offline';
            
            // Show base intensity
            const displayIntensity = gameConfig.intensity === 'mixmaster' ? 'Mixmaster' : gameConfig.intensity;
            document.getElementById('gameIntensity').textContent = displayIntensity;
            
            // Show mixmaster indicator if needed
            if (gameConfig.intensity === 'mixmaster') {
                document.getElementById('mixmasterIndicator').style.display = 'inline-block';
            }
            
            document.getElementById('roomCode').textContent = gameConfig.roomCode || 'OFFLINE';
        }
        
        async function loadNextQuestion() {
            try {
                // Reset rating buttons
                resetRatingButtons();
                
                // Call API endpoint
                const response = await fetch(`/api/question/${gameConfig.game}/${gameConfig.intensity}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('API response:', data);
                
                if (data.success && data.question) {
                    currentQuestionId = data.questionId;
                    currentQuestionData = data;
                    displayQuestion(data.question);
                    
                    // Update mixmaster indicator if random intensity was used
                    if (gameConfig.intensity === 'mixmaster' && data.intensity) {
                        const intensityEmoji = {
                            'medium': 'üòä',
                            'spicy': 'üå∂Ô∏è',
                            'cancelled': '‚ò†Ô∏è'
                        };
                        document.getElementById('mixmasterIndicator').textContent = 
                            `üé≤ ${intensityEmoji[data.intensity]} ${data.intensity.toUpperCase()}`;
                    }
                } else {
                    showError(`No questions available. Try a different intensity level.`);
                }
            } catch (error) {
                console.error('Failed to fetch question:', error);
                showError('Failed to load question. Please check your connection and try again.');
            }
        }
        
        function displayQuestion(question) {
            currentQuestionIndex++;
            hasRatedCurrentQuestion = false;
            
            // Clear any errors
            document.getElementById('errorMessage').style.display = 'none';
            
            // Update question number
            document.getElementById('questionNumber').textContent = `Question ${currentQuestionIndex}`;
            
            // Display question based on type
            let questionText = '';
            
            if (typeof question === 'string') {
                questionText = question;
            } else if (question.text) {
                questionText = question.text;
            } else if (question.optionA && question.optionB) {
                // Would You Rather format
                questionText = `Would you rather ${question.optionA} OR ${question.optionB}?`;
            } else if (Array.isArray(question)) {
                // FMK format
                questionText = `F*ck, Marry, Kill: ${question.join(', ')}`;
            } else {
                questionText = JSON.stringify(question);
            }
            
            document.getElementById('questionText').textContent = questionText;
        }
        
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
        
        function nextQuestion() {
            loadNextQuestion();
        }
        
        function resetRatingButtons() {
            const thumbsUp = document.getElementById('thumbsUp');
            const thumbsDown = document.getElementById('thumbsDown');
            
            thumbsUp.classList.remove('rated');
            thumbsDown.classList.remove('rated');
            thumbsUp.disabled = false;
            thumbsDown.disabled = false;
            thumbsUp.style.background = 'white';
            thumbsDown.style.background = 'white';
        }
        
        async function rateQuestion(rating) {
            if (hasRatedCurrentQuestion) return;
            
            hasRatedCurrentQuestion = true;
            
            // Visual feedback
            const button = rating === 'up' ? 
                document.getElementById('thumbsUp') : 
                document.getElementById('thumbsDown');
            
            button.classList.add('rated');
            button.style.background = rating === 'up' ? '#4ade80' : '#f87171';
            
            // Disable both buttons
            document.getElementById('thumbsUp').disabled = true;
            document.getElementById('thumbsDown').disabled = true;
            
            // Show feedback
            showRatingFeedback(rating === 'up' ? 'üëç Thanks!' : 'üëé Noted!');
            
            // Send rating to server
            try {
                const response = await fetch('/api/question/rate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        questionId: currentQuestionId,
                        rating: rating,
                        game: currentQuestionData.game,
                        intensity: currentQuestionData.intensity,
                        questionText: document.getElementById('questionText').textContent
                    })
                });
                
                const result = await response.json();
                console.log('Rating saved:', result);
            } catch (error) {
                console.error('Failed to save rating:', error);
            }
        }
        
        function showRatingFeedback(message) {
            const feedback = document.createElement('div');
            feedback.className = 'rating-feedback';
            feedback.textContent = message;
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                feedback.remove();
            }, 1000);
        }
    </script>
</body>
</html>