<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playing - Don't Drink!</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Header */
        .game-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .game-title {
            font-size: 2rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .exit-btn {
            background: #EF4444;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .exit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }
        
        /* Game Info */
        .game-info {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 30px;
            display: flex;
            gap: 30px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .info-item {
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .info-item strong {
            color: #FACC15;
            font-weight: 600;
        }
        
        /* Question Card */
        .question-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 50px;
            text-align: center;
            margin-bottom: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }
        
        .question-number {
            font-size: 1.2rem;
            color: #FACC15;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .question-text {
            font-size: 1.8rem;
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: 40px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .question-options {
            display: grid;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .option-card {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 15px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .option-card:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.02);
        }
        
        .control-btn {
            background: #10B981;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Error Message */
        .error-message {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #FCA5A5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="game-header">
            <div class="game-title" id="gameTitle">Don't Drink!</div>
            <button class="exit-btn" onclick="exitGame()">Exit Game</button>
        </div>
        
        <!-- Game Info -->
        <div class="game-info">
            <span class="info-item">Mode: <strong id="gameMode">offline</strong></span>
            <span class="info-item">Intensity: <strong id="gameIntensity">medium</strong></span>
            <span class="info-item">Players: <strong id="playerCount">0</strong></span>
            <span class="info-item">Room: <strong id="roomCode">LOADING</strong></span>
        </div>
        
        <!-- Error Message -->
        <div class="error-message" id="errorMessage" style="display: none;"></div>
        
        <!-- Question Card -->
        <div class="question-card">
            <div class="question-number" id="questionNumber">Question 1 of ∞</div>
            <div class="question-text" id="questionText">Loading question...</div>
            
            <div class="question-options" id="questionOptions"></div>
            
            <div>
                <button class="control-btn" id="nextBtn" onclick="nextQuestion()">Next Question</button>
            </div>
        </div>
    </div>
    
    <script>
        // Game state
        let gameConfig = {};
        let currentQuestionIndex = 1;
        let questions = [];
        let usedQuestions = [];
        
        // Game name mapping
        const gameNameMap = {
            'nhie': 'never_have_i_ever',
            'fmk': 'fmk',
            'wyr': 'would_you_rather',
            'hottakes': 'hot_takes'
        };
        
        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', function() {
            loadGameConfig();
            initializeGame();
        });
        
        function loadGameConfig() {
            // Get config from localStorage
            const storedConfig = localStorage.getItem('gameConfig');
            if (storedConfig) {
                gameConfig = JSON.parse(storedConfig);
                console.log('Loaded config:', gameConfig);
            }
            
            // Get params from URL
            const urlParams = new URLSearchParams(window.location.search);
            const roomCode = urlParams.get('room') || gameConfig.roomCode || 'OFFLINE';
            const game = urlParams.get('game') || gameConfig.game || 'nhie';
            
            // Fix intensity - "mixmaster" is not valid
            let intensity = gameConfig.intensity || 'medium';
            if (!['medium', 'spicy', 'cancelled'].includes(intensity)) {
                console.warn(`Invalid intensity "${intensity}", defaulting to "medium"`);
                intensity = 'medium';
            }
            
            gameConfig = {
                ...gameConfig,
                roomCode: roomCode,
                game: game,
                intensity: intensity,
                mode: gameConfig.mode || 'offline'
            };
            
            console.log('Final config:', gameConfig);
        }
        
        function initializeGame() {
            // Update UI
            updateGameInfo();
            
            // Load questions for offline mode
            if (gameConfig.mode === 'offline') {
                loadOfflineQuestions();
            }
            
            // Get first question
            loadNextQuestion();
        }
        
        function updateGameInfo() {
            const gameTitle = gameNameMap[gameConfig.game] || gameConfig.game;
            document.getElementById('gameTitle').textContent = gameTitle.replace(/_/g, ' ').toUpperCase();
            document.getElementById('gameMode').textContent = gameConfig.mode || 'offline';
            document.getElementById('gameIntensity').textContent = gameConfig.intensity || 'medium';
            document.getElementById('playerCount').textContent = gameConfig.players?.length || '0';
            document.getElementById('roomCode').textContent = gameConfig.roomCode || 'OFFLINE';
        }
        
        function loadOfflineQuestions() {
            // Fallback questions for offline mode
            const fallbackQuestions = {
                never_have_i_ever: {
                    medium: [
                        "Never have I ever sung in the shower",
                        "Never have I ever eaten a whole pizza by myself",
                        "Never have I ever lied about my age",
                        "Never have I ever stalked an ex on social media",
                        "Never have I ever pretended to be sick to skip work"
                    ],
                    spicy: [
                        "Never have I ever had a one night stand",
                        "Never have I ever sent nudes",
                        "Never have I ever hooked up with someone from work",
                        "Never have I ever had sex in public",
                        "Never have I ever used a dating app just for hookups"
                    ],
                    cancelled: [
                        "Never have I ever cheated on someone",
                        "Never have I ever stolen something worth over $100",
                        "Never have I ever hooked up with a friend's ex",
                        "Never have I ever lied about being on birth control",
                        "Never have I ever had sex with someone whose name I didn't know"
                    ]
                },
                fmk: {
                    medium: [
                        "Ryan Reynolds, Chris Evans, Tom Holland",
                        "Emma Stone, Jennifer Lawrence, Scarlett Johansson",
                        "Batman, Superman, Spider-Man"
                    ],
                    spicy: [
                        "Your ex, your ex's best friend, your ex's sibling",
                        "Your boss, your coworker, the janitor",
                        "Three people in this room"
                    ],
                    cancelled: [
                        "Your sibling's ex, your parent's friend, your cousin",
                        "Your therapist, your doctor, your lawyer",
                        "Someone for money, someone for revenge, someone for power"
                    ]
                },
                would_you_rather: {
                    medium: [
                        { optionA: "Never use social media again", optionB: "Never watch TV again" },
                        { optionA: "Be able to fly", optionB: "Be invisible" },
                        { optionA: "Win the lottery", optionB: "Live twice as long" }
                    ],
                    spicy: [
                        { optionA: "Have sex with lights always on", optionB: "Only in complete darkness" },
                        { optionA: "Give up oral sex", optionB: "Give up penetrative sex" },
                        { optionA: "Kiss your ex", optionB: "Kiss your enemy" }
                    ],
                    cancelled: [
                        { optionA: "Sleep with your boss for a promotion", optionB: "Stay in your dead-end job forever" },
                        { optionA: "Cheat and never get caught", optionB: "Be cheated on and know" },
                        { optionA: "Have sex with your cousin", optionB: "Have sex with your step-sibling" }
                    ]
                },
                hot_takes: {
                    medium: [
                        "Pineapple belongs on pizza",
                        "The book is always better than the movie",
                        "Social media does more harm than good"
                    ],
                    spicy: [
                        "Open relationships are healthier than monogamy",
                        "Body count matters in a relationship",
                        "Size does matter"
                    ],
                    cancelled: [
                        "Cheating can save a relationship",
                        "Some people deserve to be ghosted",
                        "Gold diggers provide a valuable service"
                    ]
                }
            };
            
            const dbGame = gameNameMap[gameConfig.game] || gameConfig.game;
            const intensity = gameConfig.intensity || 'medium';
            
            questions = fallbackQuestions[dbGame]?.[intensity] || [
                "Sample question - check your configuration"
            ];
            
            console.log(`Loaded ${questions.length} offline questions for ${dbGame}/${intensity}`);
        }
        
       async function loadNextQuestion() {
    // Try API first
    const dbGame = gameNameMap[gameConfig.game] || gameConfig.game;
    const intensity = gameConfig.intensity || 'medium';
    
    try {
        const response = await fetch(`/api/question/${dbGame}/${intensity}`);
        if (response.ok) {
            const data = await response.json();
            if (data.question) {
                displayQuestion(data.question);
                return;
            }
        }
    } catch (error) {
        console.log('API failed, using fallback:', error);
    }
    
    // Fallback to local questions
    if (questions.length === 0) {
        showError("No questions available. Check your game configuration.");
        return;
    }
    
    // Get a random question
    let question;
    if (usedQuestions.length >= questions.length) {
        // Reset if all questions used
        usedQuestions = [];
    }
    
    do {
        const randomIndex = Math.floor(Math.random() * questions.length);
        question = questions[randomIndex];
    } while (usedQuestions.includes(question) && questions.length > 1);
    
    usedQuestions.push(question);
    displayQuestion(question);
}
        
        function displayQuestion(question) {
            document.getElementById('questionNumber').textContent = `Question ${currentQuestionIndex} of ∞`;
            
            const dbGame = gameNameMap[gameConfig.game] || gameConfig.game;
            
            // Display based on game type
            if (dbGame === 'would_you_rather' && typeof question === 'object') {
                document.getElementById('questionText').textContent = "Would you rather...";
                document.getElementById('questionOptions').innerHTML = `
                    <div class="option-card">A: ${question.optionA}</div>
                    <div class="option-card">B: ${question.optionB}</div>
                `;
            } else if (dbGame === 'fmk' && typeof question === 'string') {
                const options = question.split(',').map(o => o.trim());
                document.getElementById('questionText').textContent = "F***, Marry, Kill:";
                document.getElementById('questionOptions').innerHTML = options.map(opt => 
                    `<div class="option-card">${opt}</div>`
                ).join('');
            } else {
                // Simple text question
                document.getElementById('questionText').textContent = 
                    typeof question === 'object' ? question.text : question;
                document.getElementById('questionOptions').innerHTML = '';
            }
        }
        
        async function nextQuestion() {
    currentQuestionIndex++;
    await loadNextQuestion();
}
        
        function exitGame() {
            if (confirm("Are you sure you want to exit the game?")) {
                localStorage.removeItem('gameConfig');
                window.location.href = '/host';
            }
        }
        
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>