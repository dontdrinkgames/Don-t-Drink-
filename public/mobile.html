<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Don't Drink! – Join</title>
  <!-- styles.css fjernet for å unngå MIME-type feil -->
</head>
<body>
  <header class="mobile-header">
    <h1>Join the game</h1>
    <div id="connectionStatus" class="connection-status info"><span>Connecting…</span></div>
  </header>

  <main class="mobile-main">
    <section id="joinScreen" class="join-screen">
      <div class="room-line">
        Room code: <strong id="displayRoomCode">———</strong>
      </div>

      <div class="name-line">
        <label for="playerName">Name</label>
        <input id="playerName" type="text" placeholder="Your name"/>
      </div>

      <div class="avatar-picker">
        <button class="avatar-btn">🙂</button>
        <button class="avatar-btn">🍺</button>
        <button class="avatar-btn">🔥</button>
        <button class="avatar-btn">🤖</button>
      </div>

      <button id="joinBtn" class="btn primary" disabled>Join</button>
    </section>

    <section id="waitingScreen" class="waiting-screen" style="display:none">
      <div class="waiting-card">
        <div id="waitingAvatar" class="waiting-avatar">🙂</div>
        <div class="waiting-text">
          <div>You are in!</div>
          <div id="waitingName" class="waiting-name">—</div>
        </div>
      </div>
      <p class="waiting-note">Waiting for the game to start…</p>
    </section>
  </main>

  <script>
let selectedAvatar = '🙂';
let playerName = '';
let roomCode = '';
let socket = null;
let clientIdKey = '';

function showError(msg) {
  const el = document.getElementById('connectionStatus');
  if (!el) return;
  el.className = 'connection-status error';
  el.querySelector('span').textContent = msg;
}
function showSuccess(msg) {
  const el = document.getElementById('connectionStatus');
  if (!el) return;
  el.className = 'connection-status connected';
  el.querySelector('span').textContent = msg;
}
function updateConnectionStatus(status, message) {
  const el = document.getElementById('connectionStatus');
  if (!el) return;
  el.className = `connection-status ${status}`;
  el.querySelector('span').textContent = message;
}

function showWaitingScreen() {
  const join = document.getElementById('joinScreen');
  const wait = document.getElementById('waitingScreen');
  if (join) join.style.display = 'none';
  if (wait) wait.style.display = 'flex';
}

function initRoomCode() {
  const parts = window.location.pathname.split('/');
  roomCode = parts[1] && parts[1].length === 6 ? parts[1].toUpperCase() : '';
  if (!roomCode) { showError('Invalid room code'); return false; }
  clientIdKey = `dd_clientId_${roomCode}`;
  const disp = document.getElementById('displayRoomCode');
  if (disp) disp.textContent = roomCode;
  return true;
}

function getOrCreateClientId() {
  let cid = localStorage.getItem(clientIdKey);
  if (!cid) {
    cid = `c_${Math.random().toString(36).slice(2,10)}${Date.now().toString(36)}`;
    localStorage.setItem(clientIdKey, cid);
  }
  return cid;
}

function loadSocketIO() {
  return new Promise((resolve, reject) => {
    if (typeof io !== 'undefined') return resolve();
    const s = document.createElement('script');
    s.src = '/socket.io/socket.io.js';
    s.onload = resolve;
    s.onerror = () => reject(new Error('Failed to load socket.io'));
    document.head.appendChild(s);
  });
}

function initializeSocket() {
  socket = io({ transports: ['websocket', 'polling'], timeout: 10000, forceNew: true });

  socket.on('connect', () => {
    updateConnectionStatus('connected', 'Connected to game server!');
    const btn = document.getElementById('joinBtn');
    if (btn) btn.disabled = false;

    const cid = localStorage.getItem(clientIdKey);
    const savedName = localStorage.getItem(`dd_name_${roomCode}`);
    const savedAvatar = localStorage.getItem(`dd_avatar_${roomCode}`) || selectedAvatar;
    if (cid && savedName) {
      playerName = savedName;
      selectedAvatar = savedAvatar;
      socket.emit('join-room', {
        roomCode,
        playerName,
        avatar: selectedAvatar,
        clientId: cid
      });
    }
  });

  socket.on('disconnect', () => {
    updateConnectionStatus('error', 'Disconnected from server');
    const btn = document.getElementById('joinBtn');
    if (btn) btn.disabled = true;
  });

  socket.on('join-error', (e) => showError(e?.message || 'Join failed'));

  socket.on('player-joined-success', (data) => {
    if (data.clientId) localStorage.setItem(clientIdKey, data.clientId);
    if (data.playerName) localStorage.setItem(`dd_name_${roomCode}`, data.playerName);
    if (data.avatar) localStorage.setItem(`dd_avatar_${roomCode}`, data.avatar);
    const wa = document.getElementById('waitingAvatar');
    const wn = document.getElementById('waitingName');
    if (wa) wa.textContent = data.avatar || selectedAvatar;
    if (wn) wn.textContent = data.playerName || playerName;
    showWaitingScreen();
    showSuccess(`Successfully joined as ${data.playerName}!`);
  });
}

function joinGame() {
  const input = document.getElementById('playerName');
  if (!input) { showError('No name field'); return; }
  const name = input.value.trim();
  if (!name || name.length < 2) { showError('Please enter your name'); return; }
  playerName = name;

  const wa = document.getElementById('waitingAvatar');
  const wn = document.getElementById('waitingName');
  if (wa) wa.textContent = selectedAvatar;
  if (wn) wn.textContent = playerName;

  if (socket && socket.connected) {
    const cid = getOrCreateClientId();
    const btn = document.getElementById('joinBtn');
    if (btn) {
      btn.textContent = 'Joining...';
      btn.disabled = true;
    }
    socket.emit('join-room', { roomCode, playerName, avatar: selectedAvatar, clientId: cid });
  } else {
    showError('Not connected to server. Please wait and try again.');
  }
}

document.addEventListener('click', (e) => {
  const btn = e.target.closest('.avatar-btn');
  if (!btn) return;
  document.querySelectorAll('.avatar-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedAvatar = btn.textContent.trim();
});

document.getElementById('joinBtn')?.addEventListener('click', joinGame);

window.addEventListener('load', async () => {
  if (!initRoomCode()) return;
  try { if (typeof io === 'undefined') await loadSocketIO(); }
  catch { showError('Failed to load socket.io'); return; }
  initializeSocket();
});
  </script>
</body>
</html>
